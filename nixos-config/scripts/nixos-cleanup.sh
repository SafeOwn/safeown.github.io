#!/usr/bin/env bash

# =============================================================
# ๐งน NixOS Full Cleanup Script (with Home Directory Support)
# โ ะะตะทะพะฟะฐัะฝะพ ะดะปั NixOS โ ะฝะต ััะพะณะฐะตั /nix/store ะฒัััะฝัั
# โ ะงะธััะธั ัะธััะตะผะฝัะต ะฟะพะบะพะปะตะฝะธั, ะบัั, ะปะพะณะธ, ะดัะฑะปะธ ะฒ /home
# โ ะะพะดะดะตัะถะบะฐ Steam/Proton, ะฑัะฐัะทะตัะพะฒ, thumbnails, etc.
# ๐ก ะะฐะฟััะบะฐัั ะพั ะพะฑััะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะฝะตะบะพัะพััะต ะบะพะผะฐะฝะดั ั sudo)
# =============================================================

sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

echo "๐ ะะฐัะธะฝะฐะตะผ ะฟะพะปะฝัั ะพัะธััะบั NixOS..."

# -------------------------------------------------------------
# 1. ะัะธััะบะฐ ััะฐััั ะฟะพะบะพะปะตะฝะธะน NixOS (ัะธััะตะผะฐ)
# -------------------------------------------------------------
echo "๐งน ะัะธัะฐะตะผ ััะฐััะต ะฟะพะบะพะปะตะฝะธั ัะธััะตะผั (ะพััะฐะฒะปัะตะผ ัะพะปัะบะพ ัะตะบััะตะต)..."
sudo nix-collect-garbage -d

# -------------------------------------------------------------
# 2. ะะฟัะธะผะธะทะฐัะธั ััะฐะฝะธะปะธัะฐ Nix (ัะฐัะดะปะธะฝะบะธ ะพะดะธะฝะฐะบะพะฒัั ัะฐะนะปะพะฒ)
# -------------------------------------------------------------
echo "๐ ะะฟัะธะผะธะทะธััะตะผ /nix/store ัะตัะตะท ัะฐัะดะปะธะฝะบะธ..."
sudo nix-store --optimise

# -------------------------------------------------------------
# 3. ะัะธััะบะฐ ะปะพะณะพะฒ systemd (journalctl)
# -------------------------------------------------------------
echo "๐๏ธ  ะัะธัะฐะตะผ ัะธััะตะผะฝัะต ะปะพะณะธ ััะฐััะต 7 ะดะฝะตะน ะธะปะธ ะฑะพะปััะต 100M..."
sudo journalctl --vacuum-time=7d 2>/dev/null || true
sudo journalctl --vacuum-size=100M 2>/dev/null || true

# -------------------------------------------------------------
# 4. ะัะธััะบะฐ ะบััะฐ nix (ะฝะต /nix/store, ะฐ download cache)
# -------------------------------------------------------------
echo "๐ฅ ะัะธัะฐะตะผ ะบัั ะทะฐะณััะทะพะบ Nix (nix store cache)..."
nix-collect-garbage --delete-older-than 1d 2>/dev/null || true

# -------------------------------------------------------------
# 5. ะัะธััะบะฐ ะฟะพะปัะทะพะฒะฐัะตะปััะบะพะณะพ ะบััะฐ (~/.cache)
# -------------------------------------------------------------
echo "๐งน ะัะธัะฐะตะผ ะบัั ะฟะพะปัะทะพะฒะฐัะตะปั: ะฑัะฐัะทะตัั, ะฟัะธะปะพะถะตะฝะธั, thumbnails..."

# ะะฟะฐัะฝัะต ะฟะฐะฟะบะธ โ ะผะพะถะฝะพ ะพัะธัะฐัั ะฟะพะปะฝะพัััั
rm -rf ~/.cache/thumbnails/*
rm -rf ~/.cache/gnome-software/*
rm -rf ~/.cache/fontconfig/*
rm -rf ~/.cache/event-sound-cache*
rm -rf ~/.cache/docbook*

# ะัะฐัะทะตัั (ะตัะปะธ ะธัะฟะพะปัะทัะตัั โ ะผะพะถะฝะพ ะทะฐะบะพะผะผะตะฝัะธัะพะฒะฐัั ะฝะตะฝัะถะฝะพะต)
rm -rf ~/.cache/mozilla/firefox/*/cache2/*
rm -rf ~/.cache/google-chrome/*/Cache/*
rm -rf ~/.cache/chromium/*/Cache/*
rm -rf ~/.cache/BraveSoftware/Brave-Browser/*/Cache/*

# Discord, Telegram, ะธ ะดั.
rm -rf ~/.cache/discord/*
rm -rf ~/.cache/TelegramDesktop/*

echo "โ ะัั ะฟะพะปัะทะพะฒะฐัะตะปั ะพัะธัะตะฝ."

# -------------------------------------------------------------
# 6. ะัะธััะบะฐ ะฟะฐะฟะบะธ ~/.local/share/Trash (ะบะพัะทะธะฝะฐ)
# -------------------------------------------------------------
echo "๐๏ธ  ะัะธัะฐะตะผ ะบะพัะทะธะฝั ะฟะพะปัะทะพะฒะฐัะตะปั..."
sudo rm -rf ~/.local/share/Trash/*

# -------------------------------------------------------------
# 7. ะัะธััะบะฐ Steam/Proton ะบััะฐ ะธ ะดัะฑะปะธะบะฐัะพะฒ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
# -------------------------------------------------------------
# if [ -d "$HOME/.local/share/Steam" ] || [ -d "$HOME/.steam" ]; then
#     echo "๐ฎ ะะฑะฝะฐััะถะตะฝ Steam โ ัะธััะธะผ ะบัั ะธ ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั..."
#
#     # ะัะธััะบะฐ ะพะฑัะตะณะพ ะบััะฐ Steam
#     rm -rf ~/.local/share/Steam/steamapps/shadercache/*
#     rm -rf ~/.local/share/Steam/steamapps/temp/*
#
#     # Proton โ ะผะพะถะฝะพ ะพััะฐะฒะธัั ัะพะปัะบะพ ะฟะพัะปะตะดะฝะธะต ะฒะตััะธะธ
#     # (ะพััะพัะพะถะฝะพ: ะตัะปะธ ัะดะฐะปะธัั โ ะฟะตัะตัััะฐะฝะพะฒะธััั ะฟัะธ ะทะฐะฟััะบะต ะธะณัั)
#     echo "โ๏ธ  ะะะะะะะะ: ะัะธััะบะฐ Proton ัะดะฐะปะธั ะฒัะต ะฒะตััะธะธ, ะบัะพะผะต ะธัะฟะพะปัะทัะตะผัั!"
#     echo "   ะัะปะธ ัะพัะตัั ะพััะฐะฒะธัั โ ะทะฐะบะพะผะผะตะฝัะธััะน ัะปะตะดัััะธะต ัััะพะบะธ."
#
#     # ะฃะดะฐะปะธัั ะะกะ ะฒะตััะธะธ Proton, ะบัะพะผะต ัะตั, ััะพ ะธัะฟะพะปัะทััััั ะธะณัะฐะผะธ
#     # ะกะฝะฐัะฐะปะฐ ะฟะพะปััะธะผ ัะฟะธัะพะบ ะธัะฟะพะปัะทัะตะผัั Proton ะฒะตััะธะน ะธะท ะบะพะฝัะธะณะพะฒ ะธะณั
#     if [ -d "$HOME/.local/share/Steam/steamapps/compatdata" ]; then
#         echo "๐ ะะฝะฐะปะธะทะธััะตะผ, ะบะฐะบะธะต ะฒะตััะธะธ Proton ะธัะฟะพะปัะทััััั ะธะณัะฐะผะธ..."
#
#         # ะกะพะทะดะฐะตะผ ะฒัะตะผะตะฝะฝัะน ัะฐะนะป ะดะปั ััะฐะฝะตะฝะธั ะธัะฟะพะปัะทัะตะผัั ะฒะตััะธะน
#         USED_PROTONS=$(mktemp)
#         find "$HOME/.local/share/Steam/steamapps/compatdata" -name "compatibilitytool.vdf" 2>/dev/null | while read vdf; do
#             grep -oP 'compat_tool_name"\s*"\K[^"]+' "$vdf" 2>/dev/null | while read tool; do
#                 echo "$tool" >> "$USED_PROTONS"
#             done
#         done
#
#         # ะฃะฝะธะบะฐะปัะฝัะต ะธะผะตะฝะฐ
#         sort -u "$USED_PROTONS" -o "$USED_PROTONS"
#
#         # ะฃะดะฐะปัะตะผ ะะะธัะฟะพะปัะทัะตะผัะต ะฒะตััะธะธ Proton
#         PROTON_DIR="$HOME/.local/share/Steam/steamapps/common"
#         for proton in "$PROTON_DIR"/Proton*; do
#             if [ -d "$proton" ]; then
#                 proton_name=$(basename "$proton")
#                 if ! grep -q "^$proton_name$" "$USED_PROTONS"; then
#                     echo "โ ะฃะดะฐะปัะตะผ ะฝะตะธัะฟะพะปัะทัะตะผัะน Proton: $proton_name"
#                     rm -rf "$proton"
#                 else
#                     echo "โ ะััะฐะฒะปัะตะผ ะธัะฟะพะปัะทัะตะผัะน Proton: $proton_name"
#                 fi
#             fi
#         done
#
#         rm -f "$USED_PROTONS"
#     fi
#
#     # ะัะธััะบะฐ shader cache (ะผะพะถะฝะพ ะฒัะตะณะดะฐ โ ะฟะตัะตัะพัะผะธััะตััั)
#     rm -rf ~/.local/share/Steam/steamapps/shadercache/*
# fi

# -------------------------------------------------------------
# 8. ะะพะธัะบ ะธ ัะดะฐะปะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ ะฒ /home (ะพะฟัะธะพะฝะฐะปัะฝะพ, ััะตะฑัะตั fdupes)
# -------------------------------------------------------------
if command -v fdupes >/dev/null 2>&1; then
    echo "๐ ะัะตะผ ะดัะฑะปะธะบะฐัั ะฒ ะดะพะผะฐัะฝะตะน ะดะธัะตะบัะพัะธะธ (ะธัะบะปััะฐั .cache ะธ .local/share/Steam)..."
    echo "โ๏ธ  ะะะะะะะะ: ัะบัะธะฟั ะะ ะะฃะะะข ัะดะฐะปััั ะดัะฑะปะธะบะฐัั ะฐะฒัะพะผะฐัะธัะตัะบะธ โ ัะพะปัะบะพ ะฟะพะบะฐะถะตั."
    echo "   ะงัะพะฑั ัะดะฐะปะธัั โ ะทะฐะฟัััะธ ะฒัััะฝัั ั ัะปะฐะณะพะผ -d"

    fdupes -r -f -q \
        --exclude=".cache" \
        --exclude=".local/share/Steam" \
        --exclude=".thumbnails" \
        "$HOME" | grep -v "^$" || echo "ะัะฑะปะธะบะฐัั ะฝะต ะฝะฐะนะดะตะฝั."

    echo "๐ก ะกะพะฒะตั: ััะพะฑั ัะดะฐะปะธัั ะดัะฑะปะธะบะฐัั ะฒัััะฝัั: fdupes -rdN \$HOME"
else
    echo "๐ฆ ะฃััะฐะฝะพะฒะธ fdupes ะดะปั ะฟะพะธัะบะฐ ะดัะฑะปะธะบะฐัะพะฒ: nix-env -iA nixpkgs.fdupes"
fi

# -------------------------------------------------------------
# 9. ะคะธะฝะฐะปัะฝะฐั ััะฐัะธััะธะบะฐ
# -------------------------------------------------------------
echo "๐ ะกัะฐัะธััะธะบะฐ ะฟะพัะปะต ะพัะธััะบะธ:"

echo "๐พ ะะฐะทะผะตั /nix/store:"
sudo du -sh /nix/store 2>/dev/null

echo "๐ ะะฐะทะผะตั ะดะพะผะฐัะฝะตะน ะดะธัะตะบัะพัะธะธ:"
du -sh "$HOME" 2>/dev/null

echo "๐ ะะฐะทะผะตั ะบััะฐ ะฟะพะปัะทะพะฒะฐัะตะปั:"
du -sh "$HOME/.cache" 2>/dev/null

echo "๐ ะัะธััะบะฐ ะทะฐะฒะตััะตะฝะฐ! ะกะธััะตะผะฐ ะปะตะณัะต ะธ ะฑััััะตะต."
