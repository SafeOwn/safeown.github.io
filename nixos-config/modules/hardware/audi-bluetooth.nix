# ========================================
# üîä /etc/nixos/audi-bluetooth.nix
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ (PipeWire) –∏ Bluetooth
# –£–ø—Ä–∞–≤–ª—è–µ—Ç:
# - –í–∫–ª—é—á–µ–Ω–∏–µ–º Bluetooth
# - –ù–∞—Å—Ç—Ä–æ–π–∫–æ–π PipeWire –≤–º–µ—Å—Ç–æ PulseAudio
# - –ü–æ–¥–¥–µ—Ä–∂–∫–æ–π ALSA, 32-–±–∏—Ç–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, Pulse-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
# –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–º–∏ –ø–ª–∞—Ç–∞–º–∏, –≤–∫–ª—é—á–∞—è MSI
# ========================================
{ pkgs, lib, ... }:  # –î–æ–±–∞–≤–ª–µ–Ω `lib` ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è mkForce

{
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UCM-–ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è Realtek (–≤–∞–∂–Ω–æ –¥–ª—è 5.1)
  environment.systemPackages = with pkgs; [
    alsa-utils
    alsa-ucm-conf
    pulseaudioFull  # ‚Üê –¥–ª—è pactl, pavucontrol, ucm-–ø—Ä–æ—Ñ–∏–ª–µ–π
  ];

  hardware = {
    # ========================================
    # üì∂ Bluetooth
    # –í–∫–ª—é—á–∞–µ—Ç Bluetooth –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    # ========================================
    bluetooth = {
      enable = true;                    # ‚úÖ –í–∫–ª—é—á–∏—Ç—å Bluetooth
      powerOnBoot = true;               # ‚úÖ –í–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      settings.General = {
        Experimental = true;            # ‚úÖ –í–∫–ª—é—á–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (LE Audio –∏ –¥—Ä.)
        # ControllerMode = "bredr";     # ‚ö†Ô∏è –¢–æ–ª—å–∫–æ Classic Bluetooth (–Ω–µ –Ω—É–∂–Ω–æ)
      };
    };
  };

  services = {
    # ========================================
    # üéß –ê—É–¥–∏–æ: PipeWire –≤–º–µ—Å—Ç–æ PulseAudio
    # –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—É–¥–∏–æ-–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    # ========================================
    pulseaudio.enable = lib.mkForce false;  # ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–∏—Å PulseAudio (—á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å PipeWire)

    pipewire = {
      enable = true;                   # ‚úÖ –í–∫–ª—é—á–∏—Ç—å PipeWire
      audio.enable = true;             # ‚úÖ –í–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ
      wireplumber.enable = true;       # ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–∞–Ω–∞–ª–æ–≥ pulseaudio-module-device-restore)
      alsa.enable = true;              # ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ALSA (–≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
      alsa.support32Bit = true;        # ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 32-–±–∏—Ç–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (Wine, —Å—Ç–∞—Ä—ã–µ –∏–≥—Ä—ã)
      pulse.enable = true;             # ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PulseAudio (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

      # jack.enable = true;            # ‚ö†Ô∏è –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã JACK-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (DAW, Ardour)
    };
  };


    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å UCM –¥–ª—è MSI
    boot.extraModprobeConfig = ''
      options snd-hda-intel model=msi-headset-multi
    '';
}
