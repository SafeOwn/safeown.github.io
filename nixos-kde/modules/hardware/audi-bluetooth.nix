# ========================================
# üîä /etc/nixos/audi-bluetooth.nix
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ (PipeWire) –∏ Bluetooth
# –£–ø—Ä–∞–≤–ª—è–µ—Ç:
# - –í–∫–ª—é—á–µ–Ω–∏–µ–º Bluetooth
# - –ù–∞—Å—Ç—Ä–æ–π–∫–æ–π PipeWire –≤–º–µ—Å—Ç–æ PulseAudio
# - –ü–æ–¥–¥–µ—Ä–∂–∫–æ–π ALSA, 32-–±–∏—Ç–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, Pulse-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
# –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–º–∏ –ø–ª–∞—Ç–∞–º–∏, –≤–∫–ª—é—á–∞—è MSI
# ========================================
{ pkgs, lib, ... }:  # –î–æ–±–∞–≤–ª–µ–Ω `lib` ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è mkForce

{

  # ========================================
  # üêß –Ø–¥—Ä–æ: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∞—É–¥–∏–æ
  # –û—Ç–∫–ª—é—á–∞–µ–º SOF, –≤–∫–ª—é—á–∞–µ–º legacy HDA, —É–±–∏—Ä–∞–µ–º –º–µ—à–∞—é—â–∏–µ –¥—Ä–∞–π–≤–µ—Ä—ã
  # ========================================
  boot.kernelParams = [
    "snd-intel-dspcfg.dsp_driver=1"    # ‚Üê –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å legacy HDA, –∞ –Ω–µ SOF
    "snd_hda_intel.dmic_detect=0"      # ‚Üê –û—Ç–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–µ–∫—Ç —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤ (—á–∞—Å—Ç–æ –ª–æ–º–∞–µ—Ç Realtek)
    "modprobe.blacklist=snd_sof_pci_intel_tgl,snd_sof_intel_hda_common,snd_sof_intel_hda_generic,snd_sof"  # ‚Üê —è–≤–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º SOF
  ];


  # ========================================
  # üìÅ –°–∏—Å—Ç–µ–º–∞: –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –Ω–∞–ª–∏—á–∏–µ UCM-–ø—Ä–æ—Ñ–∏–ª–µ–π ALSA
  # –ë–µ–∑ –Ω–∏—Ö PipeWire –Ω–µ —Å–º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å 5.1 –∏ —Ñ–æ—Ä–º–∞—Ç—ã
  # ========================================
  environment.etc."alsa/ucm".source = "${pkgs.alsa-ucm-conf}/share/alsa/ucm";


  # ========================================
  # üì¶ –ü–∞–∫–µ—Ç—ã: –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º
  # pactl, pavucontrol, –ø—Ä–æ—Ñ–∏–ª–∏ Realtek ‚Äî –≤—Å—ë –∑–¥–µ—Å—å
  # ========================================
  environment.systemPackages = with pkgs; [
    alsa-utils
    alsa-ucm-conf
    pulseaudioFull  # ‚Üê –¥–ª—è pactl, pavucontrol, ucm-–ø—Ä–æ—Ñ–∏–ª–µ–π
    pavucontrol
  ];


  # ========================================
  # üì∂ Bluetooth: –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LE Audio, –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  # ========================================
  hardware.bluetooth = {
    enable = true;                    # ‚úÖ –í–∫–ª—é—á–∏—Ç—å Bluetooth
    powerOnBoot = true;               # ‚úÖ –í–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    settings.General = {
      Experimental = true;            # ‚úÖ –í–∫–ª—é—á–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (LE Audio –∏ –¥—Ä.)
      # ControllerMode = "bredr";     # ‚ö†Ô∏è –¢–æ–ª—å–∫–æ Classic Bluetooth (–Ω–µ –Ω—É–∂–Ω–æ)
    };
  };


  # ========================================
  # üéß –ê—É–¥–∏–æ: –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–µ–∫ ‚Äî PipeWire –≤–º–µ—Å—Ç–æ PulseAudio
  # –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ALSA –∏ 32-–±–∏—Ç
  # ========================================
  services.pulseaudio.enable = lib.mkForce false;  # ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º PulseAudio

  services.pipewire = {
    enable = true;                   # ‚úÖ –í–∫–ª—é—á–∏—Ç—å PipeWire
    audio.enable = true;             # ‚úÖ –í–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ
    wireplumber.enable = true;       # ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (–∞–Ω–∞–ª–æ–≥ device-restore)
    alsa.enable = true;              # ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö ALSA-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
    alsa.support32Bit = true;        # ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 32-–±–∏—Ç (Wine, —Å—Ç–∞—Ä—ã–µ –∏–≥—Ä—ã)
    pulse.enable = true;             # ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PulseAudio-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏

    # jack.enable = true;            # ‚ö†Ô∏è –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã JACK-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (DAW, Ardour)
  };


  # ========================================
  # üéöÔ∏è PipeWire: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—á–∞—Å—Ç–æ—Ç–∞, –±—É—Ñ–µ—Ä, –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞)
  # –ß–µ—Ä–µ–∑ configPackages ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π —Å–ø–æ—Å–æ–± –≤ NixOS 24.11+
  # ========================================
  services.pipewire.configPackages = [
    (pkgs.writeTextDir "share/pipewire/pipewire.conf.d/99-audio-rate.conf" ''
      context.properties = {
        default.clock.rate = 48000
        default.clock.quantum = 2048
        default.clock.min-quantum = 1024
        default.clock.max-quantum = 8192
      }

      stream.properties = {
        resample.quality = 6
      }
    '')
  ];


  # ========================================
  # üéõÔ∏è WirePlumber: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ USB-–∞—É–¥–∏–æ (Realtek ALC4080)
  # –ó–∞–¥–∞—ë–º 24-–±–∏—Ç, 48 –∫–ì—Ü, 6 –∫–∞–Ω–∞–ª–æ–≤, –±—É—Ñ–µ—Ä ‚Äî –∫–∞–∫ –≤ Windows "Studio Quality"
  # ========================================
  services.pipewire.wireplumber.configPackages = [
    (pkgs.writeTextDir "share/wireplumber/main.lua.d/50-usb-audio-realtek.lua" ''
      rule = {
        matches = {
          {
            { "node.name", "matches", "alsa_output.usb-Generic_USB_Audio-00.*Speaker__sink" },
          },
        },
        apply_properties = {
          ["audio.rate"] = 48000,
          ["audio.format"] = "S24_3LE",     -- ‚Üê 24-–±–∏—Ç, –∫–∞–∫ –≤ Windows (—Å—Ç—É–¥–∏–π–Ω–∞—è –∑–∞–ø–∏—Å—å)
          ["audio.channels"] = 6,
          ["clock.quantum"] = 2048,         -- ‚Üê –±—É—Ñ–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          ["resample.quality"] = 6,
        },
      }

      table.insert(alsa_monitor.rules, rule)
    '')
  ];


  # ========================================
  # ‚öôÔ∏è –Ø–¥—Ä–æ: –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
  # –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏, –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è realtime-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
  # ========================================
  boot.kernel.sysctl = {
    "vm.min_free_kbytes" = 131072;       # ‚Üê –±–æ–ª—å—à–µ —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏ –¥–ª—è –∞—É–¥–∏–æ
    "kernel.sched_rt_runtime_us" = 950000; # ‚Üê –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è realtime-–∞—É–¥–∏–æ
  };


  # ========================================
  # üö´ ALSA dmix: –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (–Ω–µ –≤–∫–ª—é—á–∞—Ç—å!)
  # –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –≤ PipeWire –Ω–µ –Ω—É–∂–Ω–æ, –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  # ========================================
  # environment.etc."asound.conf".text = ''
  #   pcm.!default {
  #     type plug
  #     slave.pcm "dmixer"
  #   }
  #
  #   pcm.dmixer {
  #     type dmix
  #     ipc_key 1024
  #     slave {
  #       pcm "hw:1,0"
  #       period_time 0
  #       period_size 2048
  #       buffer_size 65536
  #       rate 48000
  #       format S24_3LE
  #     }
  #     bindings {
  #       0 0
  #       1 1
  #       2 2
  #       3 3
  #       4 4
  #       5 5
  #     }
  #   }
  #
  #   ctl.!default {
  #     type hw
  #     card 1
  #   }
  # '';


  # ========================================
  # üéöÔ∏è ALSA: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ UCM-–ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è MSI
  # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî auto –æ–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ª—É—á—à–µ —è–≤–Ω–æ
  # ========================================
  boot.extraModprobeConfig = ''
    options snd-hda-intel model=auto
  '';

}
